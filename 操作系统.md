- 网课（王道操作系统）（共84节）：1、2、3、4、5、6、7、8、**9**、10、11、

# 一.操作系统概述

## （一）.操作系统的概念、功能和目标

### 1.操作系统的概念

- 操作系统（Operating System，OS）：是指控制和管理整个计算机系统的硬件和软件资源，并合理地组织调度计算机的工作和资源的分配；以提供给用户和其他软件方便的接口和环境；它是计算机系统中最基本的系统软件。
  - 操作系统是系统资源的管理者
  - 向上层提供方便易用的服务
  - 是最接近硬件的一层软件

### 2.操作系统的功能和目标

#### （1）作为系统资源的管理者

- 提供的功能：
  - 处理机管理
  - 存储管理
  - 文件管理
  - 设备管理
- 目标：
  - 安全
  - 高效
- 补充：执行一个程序前需要将该程序放到内存中，才能被CPU处理

#### （2）向上层提供方便易用的服务

- 封装思想：操作系统把一些丑陋的硬件功能封装成一个简单易用的服务，使用户能更方便地使用计算机，用户无需关心底层硬件的原理，只需要对操作系统发出命令即可
- 直接给用户使用的：
  - GUI：图形化用户接口
    - 如：Windows、安卓、ios的图形化操作页面

  - 命令接口：

    - 联机命令接口（交互式命令接口）
      - 特点：用户说一句，系统做一句

    - 脱机命令接口（批处理命令接口）
      - 特点：用户说一堆，系统做一堆

- 给软件/给程序员使用的：
  - 程序接口（系统调用）：可以在程序中进行系统调用来使用程序接口。普通用户不能直接使用程序接口，只能通过程序代码间接使用


#### （3）作为最接近硬件的层次

- 需要实现对硬件机器的拓展
- 没有任何软件支持的计算机成为裸机。在裸机上安装操作系统，可以提供资源管理功能和方便用户的服务功能，将裸机改造成功能更强。使用更方便的机器
- 通常把覆盖了软件的机器称为扩充机器，又称虚拟机
- 操作系统对硬件机器的拓展，将CPU、内存、磁盘、显示器、键盘等硬件合理的组织起来，让各种硬件能够相互协调配合，实现更多更复杂的功能

## （二）操作系统的特征

- 操作系统的四个特征：
  1. 并发
  2. 共享
  3. 虚拟
  4. 异步
- 并发和共享为两个最基本的特征，二者互为存在条件
- 重点理解：
  - 并发和并行的区别
  - 并发和共享互为存在条件
  - 并发和共享为两个最基本的特征，没有并发和共享就谈不上虚拟和异步

### 1.并发

- 并发：指两个或多个事件在同一时间间隔内发生。这些事件宏观上是同时发生的，但在微观上是交替发生的。
- 并行：指两个或多个事件在同一时刻同时发生
- 操作系统的并发性：计算机系统中“同时”运行着多个程序，这些程序宏观上看是同时运行着，而微观上看是交替运行的
  - 操作系统就是伴随着“多道程序技术”而出现的。因此，操作系统和程序并发是一起诞生的
  - 注意：
    - 单核CPU同一时刻只能执行一个程序，各个程序之间只能并发执行
    - 多核CPU同一时刻可以同时执行，多个程序可以并行执行
- 并发性是操作系统一个最基本的特性

### 2.共享

- 共享：即资源共享，指系统中的资源可供内存中多个并发执行的过程共同使用
- 两种资源共享方式：
  - 互斥共享方式：系统中的某些资源，虽然可以提供给多个进程使用，但一个时间段内只允许一个进程访问该资源
  - 同时共享方式：系统中的某些资源，允许一个时间段内由多个进程“同时”对它们进行访问
    - 所谓的“同时”往往是宏观上的，而在微观上，这些进程可能是交替地对该资源进行访问的（即分时共享）

### 并发和共享的关系

- 并发性和共享性互为存在条件
- 若失去其中一个特性，则另一个特性则失去意义

### 3.虚拟

- 虚拟：指把一个物理上的实体变为若干个逻辑上的对应物。物理实体是实际存在的，而逻辑上对应物是用户感受到的。
  - 问题：多个程序同时运行时所需的内存远大于电脑内存，为什么还可以正常运行？
    - 答：虚拟存储技术，空分复用技术（第三章）。实际只有4GB的内存，在用户看来远远大于4GB
  - 问题：一个程序需要被分配CPU才能正常执行，为什么单核CPU的电脑中能同时运行多个程序呢？
    - 答：虚拟处理器技术，时分复用技术。微观上处理机在各个微小的时间段内交替为各个进程服务。实际上只有一个单核CPU，但在用户看来似乎有多个CPU在同时工作
- 虚拟技术：
  - 空分复用技术（如：虚拟存储技术）
  - 时分复用技术（如：虚拟处理机技术）
    - 如果失去并发性，则一个时间段内只需运行一道程序，那么就失去了虚拟性的意义。因此，没有并发性，就谈不上虚拟性

### 4.异步

- 异步：在多道程序下，允许多个程序并发执行，但由于资源有限，进程的执行不是一贯到底的，而是走走停停，以不可预知的速度向前推进，这就是进程的异步性。
- 如果系统失去了并发性，即系统只能串行地运行各个程序，那么每个程序的执行才会一贯到底。只有系统拥有并发性，才有可能导致异步性

## （三）操作系统的发展和分类

- 重点：关注和理解各类操作系统主要想解决的是什么问题，各自的优缺点

### 1.手工操作阶段

- 主要缺点：用户独占全机，人机速度矛盾导致资源利用率极低

### 2.批处理阶段

- 单道批处理系统：
  - 引入脱机输入/输出技术（由外围机+磁盘完成），并由监督程序负责程序控制作业的输入、输出
  - 主要优点：缓解了一定程度的人机速度矛盾，资源利用率有所提升。
  - 主要缺点：内存中仅能有一道程序运行，只有该程序运行结束之后才能调入下一道程序。CPU有大量的时间是在空闲等待IO完成。资源利用率仍然很低
- 多道批处理系统：
  - 每次往内存中读入多道程序，操作系统正式诞生，用于支持多道程序并发进行
  - 主要优点：多道程序并发执行，共享计算机资源。资源利用率大幅提升，CPU和其他资源更能保持忙碌状态，系统吞吐量增大
  - 主要缺点：用户响应时间长，没有人机交互功能（用户提交自己的作业之后就只能等待计算机处理完成，中间不能控制自己的作业执行。例：无法调试程序，无法在程序运行过程中输入一些参数）

### 3.分时操作系统

- 计算机会以时间片为单位轮流为各个用户/作业服务，各个用户可通过终端与计算机进行交互。
- 主要优点：用户请求可以被及时响应，解决了人机交互问题。允许多个用户同时使用一台计算机，并且用户对计算机的操作相互独立，感受不到别人的存在。
- 主要缺点：不能优先处理一些紧急任务。操作系统对各个用户/作业都是完全公平的，循环地为各个用户/作业服务一个时间片，不区分任务的紧急性

### 4.实时操作系统

- 主要优点：能够优先响应一些紧急任务，某些紧急任务不需时间片排队。
- 在实时操作系统的控制下，计算机系统接收到外部信号后及时处理，并且要在严格的时限内处理完事件。实时操作系统的主要特点是及时性和可靠性
- 实时操作系统：
  - 硬实时系统：必须在绝对严格的规定时间内完成处理
  - 软实时系统：能够接受偶尔违反时间规定

### 5.其他几种操作系统

- 网络操作系统：是伴随着计算机网络的发展而诞生的，能把网络中各个计算机有机地结合起来。实现数据传送等功能，实现网络中各种资源的共享和各台计算机之间的通信。
- 分布式操作系统：主要特点是分布性和并行性。系统中的各台计算机地位相同，任何工作都可以分布在这些计算机上，由它们并行、协同完成这个任务。
- 个人计算机操作系统：windows、macos

## （四）操作系统的运行机制

- 总览：
  - 两种指令：
    - 特权指令
    - 非特权指令

  - 两种处理器状态：
    - 核心态
    - 用户态

  - 两种程序：
    - 内核程序
    - 应用程序

- 指令：就是处理器（CPU）能识别、执行的最基本命令
- 很多内核程序组成“操作系统内核”，简称“内核”。内核是操作系统最重要最核心的部分，也是最接近硬件的部分
  - 应用程序只能使用“非特权指令”，如：加法指令、减法指令等
  - 操作系统内核作为管理者，如：内存清零指令。这些指令影响重大，只允许操作系统内核使用

- 在CPU设计和生产时就划分了特权指令和非特权指令，因此CPU在执行一条指令前就能判断出其类型
- CPU有两种状态：
  - 内核态：处于内核态时，说明此时正在运行的时内核程序，此时可以执行特权指令
    - 内核态，又名核心态、管态

  - 用户态：处于用户态时，说明此时正在运行的是应用程序，此时只能执行非特权指令
    - 用户态，又名目态

- 拓展：CPU中有一个寄存器叫程序状态字寄存器（PSW），其中有个二进制位，1表示内核态，2表示用户态
- 内核态、用户态的切换：
  - 内核态切换为用户态：执行一条特权指令，修改PSW的标志位为用户态，这个动作意味着操作系统将主动让出CPU使用权
  - 用户态切换为内核态：由中断引发，硬件自动完成变态过程，触发中断信号意味着操作系统将强行夺回CPU的使用权
    - 除了非法使用特权指令之外，还有很多事件会触发中断信号。一个共性是，但凡需要操作系统介入的地方，都会触发中断信号


## （五）中断和异常

- 总览：
  - 中断的作用
  - 中断的类型
    - 内中断（异常）
    - 外中断
  - 中断机制的基本原理
- 中断的作用：
  - 中断，会使CPU由用户态变为内核态，使操作系统重新夺回对CPU的控制权
  - 中断，是让操作系统内核夺回CPU使用权的唯一途径
- 中断的类型：
  - 内中断（异常）：与当前执行的指令有关，中断信号来源于CPU内部
    - 内中断的分类：
      - 陷阱、陷入（trap）
      - 故障（fault）
      - 终止（abort）
    - 内中断的例子：
      1. 试图在用户态下执行特权指令（终止）
      2. 当前执行的指令是非法的（如：执行除法指令时发现除数为零）（终止）
      3. 应用程序想请求操作系统内核服务，此时会执行一条特殊的指令，陷入指令，该指令会引发一个内部中断信号
         - 注意：执行陷入指令，意味着应用程序主动地将CPU控制权还给操作系统内核。系统调用就是通过陷入指令完成的
  - 外中断：与当前执行的指令无关，中断信号来源于CPU外部
    - 外中断的例子：
      1. 时钟中断：由时钟部件发来的中断信号
      2. IO中断：由输入输出设备发来的中断信号
- 中断机制的基本原理：
  - 不同的中断信号，需要用不同的中断处理程序来处理。当CPU检测到中断信号后，会根据中断信号的类型去查询中断向量表，以此来找到相应的中断处理程序在内存中的存放位置

## （六）系统调用

- 总览：
  - 什么是系统调用？
  - 系统调用和库函数的区别？
  - 为什么系统调用是必须的
  - 什么功能要用系统调用实现
  - 系统调用的过程
- 什么是系统调用，有何作用：
  - 系统调用是操作系统提供给应用程序使用的接口，可以理解为一种可供应用程序调用的特殊函数，应用程序可以通过系统调用来请求获得操作系统内核的服务
- 系统调用和库函数的区别：
  - 普通应用程序，可之间进行系统调用，也可使用库函数，有的库函数设计系统调用，有的不涉及
  - 编程语言，向上提供库函数。有时会将系统调用封装成库函数，以隐藏库函数调用的一些细节
  - 操作系统，向上提供系统调用，使得上层程序能请求内核的服务
- 为什么系统调用是必须的
  - 由操作系统内核对共享资源进行统一的管理，并向上提供系统调用，用户进程想要使用打印机这种共享资源只能通过系统调用向操作系统向操作系统内核发出请求，内核会对各个请求进行协调管理
- 什么功能要用系统调用实现：
  - 应用程序通过系统调用请求操作系统的服务。而系统中的各种共享资源都由操作系统内核统一掌管，因此凡是与共享资源有关的操作（如存储分配，IO操作，文件管理），都必须通过系统调用的方式向操作系统内核提出服务请求，由操作系统内核代为完成。这样可以保证系统的稳定性和安全性，防止用户进行非法操作
  - 按功能分类：
    - 设备管理：完成设备的请求/释放/启动等功能
    - 文件管理：完成文件的读/写/创建/删除等功能
    - 进程控制：完成进程的创建/撤销/阻塞/唤醒等功能
    - 进程通信：完成进程之间的消息传递/信号传递等功能
    - 内存管理：完成内存的分配/回收等功能
- “Linux操作系统提供了哪些系统调用”
- 系统调用的过程：
  - 传递系统调用参数
  - 执行陷入指令（用户态下）
  - 执行相应的内核请求程序处理系统调用（核心态下）
  - 返回应用程序
- 注意别名：陷入指令=trap指令=访管指令

## （七）操作系统体系结构

- 总览：
  - 大内核（又名：宏内核/单内核）
  - 微内核
  - 分层结构
  - 模块化
  - 外核
- 原语：是一种特殊的程序。具有原子性，也就是说，这段程序必须一气呵成，不可被中断
- Ubuntu、CentOS的开发团队，其主要工作是实现非内核功能，而内核都是用Linux内核
- 内核时操作系统最基本、最核心的部分。实现操作系统内核功能的程序就是内核程序
- 操纵系统内核：
  - 时钟管理：实现计时功能
  - 中断处理：负责实现中断机制
  - 原语：
    - 是一种特殊的程序
    - 处于操作系统最底层，是最接近硬件的部分
    - 具有原子性，这段程序必须一气呵成，不可被中断
    - 运行时间较短，调用频繁
  - 对系统资源进行管理的功能：
    - 进程管理
    - 存储器管理
    - 设备管理
- 保留资源管理功能的内核叫大内核；不保留的叫微内核
- 注意：
  - 操作系统内核需要运行在内核态
  - 操作系统的非内核功能运行在用户态
- 大内核和微内核对比：
  - 大内核：
    - 将操作系统的主要功能模块都作为系统内核，运行在核心态
    - 优点：高性能
    - 缺点：内核代码庞大，结构混乱，难以维护
  - 微内核：
    - 只把最基本的的功能保留在内核
    - 优点：内核功能少，结构清晰，方便维护
    - 缺点：需要频繁地在核心态和用户态之间切换，性能低
- 典型的大内核/宏内核/单内核操作系统：Linux、Unix
- 典型的微内核操作系统：Windows NT
- 分层结构：
  - 特性、思想：内核分多层，每层可单向调用更低一层提供的接口
  - 优点：
    1. 便于调试和验证，自底向上逐层调试验证
    2. 易扩充和易维护，各层之间调用接口清晰固定
  - 缺点：
    1. 仅可调用相邻低层，难以合理各层的边界
    2. 效率低，不可跨层调用，系统调用执行时间长
- 模块化：
- 大内核：
- 微内核
- 外核：

## （八）操作系统引导

- 总览：
  - 什么是操作系统引导
  - 磁盘里有哪些相关数据
  - 操作系统引导的过程
- 操作系统引导：
  1. CPU从一个特定主存地址开始，取指令，执行ROM中的引导程序（先进行硬件自检，再开机）
  2. 将磁盘的第一块，主引导记录读入内存，执行磁盘引导程序，扫描分区表
  3. 从活动分区（又称主分区，即安装了操作系统的分区）读入分区引导记录，执行其中的程序
  4. 从根目录下找到完整的操作系统初始化程序（即启动管理器）并执行，完成开机的一系列动作
- windows操作系统的完整开机初始化程序在根目录/Windows/Boot下

## （九）虚拟机

- 虚拟机：使用虚拟化技术，将一台物理机器虚拟化为多台虚拟机器（Virtual Machine，VM），每个虚拟机可以独立运行一个操作系统

- 同义术语：虚拟机管理程序，虚拟机监控程序（Virtual Machine Monitor/Hypervisor）

  - 第一类VMM：直接运行在硬件上
  - 第二类VMM：运行在宿主操作系统上

- 两类虚拟机管理程序VMM的对比：

  - 对物理资源的对比：
    - 第一类：直接运行在硬件之上，能直接控制和分配物理资源
    - 第二类：运行在Host OS之上，依赖于Host OS为其分配物理资源

  - 资源分配方式：
    - 第一类：在安装Guest OS的时候，VMM要在原本的硬盘上自行分配空间，类似于外核的分配方式，分配未经抽象的物理硬件
    - 第二类：Guest OS拥有自己的虚拟硬盘，该盘事件上是Host OS文件系统中的一个大文件。Guest OS分配到的内存是虚拟内存
  - 性能：
    - 第一类：性能更好
    - 第二类：性能更差，需要HostOS作为中介
  - 可支持的虚拟机数量：
    - 第一类：更多，不需要和Host OS竞争资源，相同的硬件资源可以支持更多虚拟机
    - 第二类：更少，Host OS本身需要使用物理资源，Host OS上运行的其他进程也需要物理资源
  - 虚拟机的可迁移性：
    - 第一类：更差
    - 第二类：更好，只需导出虚拟机镜像文件即可迁移到另一台Host OS上，商业化应用更广泛
  - 运行模式：
    - 第一类：运行在最高特权级，可以执行最高特权的指令
    - 第二类：部分运行在用户态、部分运行在核心态。Guest OS发出的系统调用会被VMM截获，并转化为VMM对Host OS的系统调用
